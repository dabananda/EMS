@model EMS.Models.ViewModels.Teacher.AttendanceViewModel

@{
    ViewData["Title"] = "Manage Attendance";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary"><i class="fa-solid fa-clipboard-user"></i> Attendance</h2>
</div>

<div class="card shadow-sm mb-4 bg-light">
    <div class="card-body">
        <form method="get" asp-action="Attendance" class="row g-3 align-items-end">

            <div class="col-md-6">
                <label class="form-label fw-bold">Select Course</label>
                <select name="courseId" class="form-select" asp-items="ViewBag.CourseList" onchange="this.form.submit()">
                    <option value="">-- Select a Course --</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Date</label>
                <input type="date" name="date" class="form-control" value="@Model.Date.ToString("yyyy-MM-dd")" onchange="this.form.submit()" />
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fa-solid fa-filter"></i> Load
                </button>
            </div>
        </form>
    </div>
</div>

@if (Model.CourseId != 0 && Model.Students.Any())
{
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        Course: <span class="text-primary">@Model.CourseTitle</span>
                        <span class="text-muted fs-6">(@Model.CourseCode)</span>
                    </h5>
                </div>

                <div>
                    <span class="badge bg-secondary me-2">Total: @Model.Students.Count</span>
                    <span class="badge bg-success me-2">Present: <span id="lblPresent">0</span></span>
                    <span class="badge bg-danger me-2">Absent: <span id="lblAbsent">0</span></span>
                    <span class="badge bg-warning text-dark">Late: <span id="lblLate">0</span></span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <form asp-action="Attendance" method="post">
                <input type="hidden" asp-for="CourseId" />
                <input type="hidden" asp-for="Date" />
                <input type="hidden" asp-for="CourseTitle" /> <input type="hidden" asp-for="CourseCode" />

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Roll No</th>
                                <th>Student Name</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Students.Count; i++)
                            {
                                <tr>
                                    <input type="hidden" asp-for="Students[i].StudentId" />
                                    <input type="hidden" asp-for="Students[i].StudentName" />
                                    <input type="hidden" asp-for="Students[i].RollNo" />

                                    <td class="ps-4 fw-bold">@Model.Students[i].RollNo</td>
                                    <td>@Model.Students[i].StudentName</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" asp-for="Students[i].Status" value="Present" id="p_@i">
                                            <label class="btn btn-outline-success btn-sm px-3" for="p_@i">P</label>

                                            <input type="radio" class="btn-check" asp-for="Students[i].Status" value="Absent" id="a_@i">
                                            <label class="btn btn-outline-danger btn-sm px-3" for="a_@i">A</label>

                                            <input type="radio" class="btn-check" asp-for="Students[i].Status" value="Late" id="l_@i">
                                            <label class="btn btn-outline-warning btn-sm px-3" for="l_@i">L</label>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-footer bg-white text-end py-3">
                    <button type="submit" class="btn btn-success px-4">
                        <i class="fa-solid fa-save"></i> Save Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>
}
else if (Model.CourseId != 0)
{
    <div class="alert alert-warning text-center mt-4">
        <i class="fa-solid fa-triangle-exclamation fa-2x mb-2"></i>
        <p>No students found for this course/semester.</p>
    </div>
}


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {

            // ১. গণনার ফাংশন
            function updateAttendanceCounts() {
                // 'Present' ভ্যালু আছে এবং চেক করা আছে এমন ইনপুট গুনো
                var presentCount = $('input[type="radio"][value="Present"]:checked').length;

                // 'Absent' ভ্যালু আছে এবং চেক করা আছে এমন ইনপুট গুনো
                var absentCount = $('input[type="radio"][value="Absent"]:checked').length;

                // 'Late' ভ্যালু আছে এবং চেক করা আছে এমন ইনপুট গুনো
                var lateCount = $('input[type="radio"][value="Late"]:checked').length;

                // ২. টেক্সট আপডেট করো
                $('#lblPresent').text(presentCount);
                $('#lblAbsent').text(absentCount);
                $('#lblLate').text(lateCount);
            }

            // ৩. পেজ লোড হওয়ার সাথে সাথে একবার রান করো (ডিফল্ট ভ্যালু দেখানোর জন্য)
            updateAttendanceCounts();

            // ৪. যেকোনো রেডিও বাটনে ক্লিক/চেঞ্জ হলে আবার রান করো (রিয়েল-টাইম আপডেট)
            $('input[type="radio"]').change(function () {
                updateAttendanceCounts();
            });
        });
    </script>
}